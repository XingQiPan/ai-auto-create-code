# 关键流程

<!-- 此文件由 AI 自动生成，描述项目的核心业务流程 -->

## 核心业务流程

### 1. 用户注册/登录流程

```
┌─────────┐     ┌─────────┐     ┌───────────┐     ┌─────────┐
│ 访问页面 │────▶│ 填写表单 │────▶│ Supabase  │────▶│ 跳转首页 │
└─────────┘     └─────────┘     │  Auth     │     └─────────┘
                                └───────────┘
```

**代码路径:**
- 登录页: `app/login/page.tsx`
- 登录表单: `components/auth/LoginForm.tsx`
- 认证客户端: `lib/supabase/client.ts`

---

### 2. 项目创建流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 填写故事内容 │────▶│ 选择视频风格 │────▶│ 创建项目    │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │ 跳转详情页   │
                                        │ (draft阶段) │
                                        └─────────────┘
```

**代码路径:**
- 创建页: `app/create/page.tsx`
- 创建表单: `components/project/CreateProjectForm.tsx`
- 项目 API: `app/api/projects/route.ts`

---

### 3. 视频生成流程（核心）

```
┌─────────────────────────────────────────────────────────────────┐
│                      视频生成 5 阶段流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐      │
│  │ draft  │────▶│ scenes │────▶│ images │────▶│ videos │      │
│  │ 草稿   │     │ 分镜   │     │ 图片   │     │ 视频   │      │
│  └────────┘     └────────┘     └────────┘     └────────┘      │
│                      │              │              │            │
│                      ▼              ▼              ▼            │
│               ┌──────────────────────────────────────────┐    │
│               │              用户确认                     │    │
│               │  每个阶段都需要用户确认才能进入下一阶段     │    │
│               └──────────────────────────────────────────┘    │
│                                             │                  │
│                                             ▼                  │
│                                      ┌────────────┐           │
│                                      │ completed  │           │
│                                      │ 完成       │           │
│                                      └────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 阶段 1: 分镜生成
```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 用户故事  │────▶│ 智谱AI   │────▶│ JSON解析 │────▶│ 存储分镜  │
│          │     │ GLM      │     │          │     │          │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
```

**API:** `POST /api/generate/scenes`
**AI 服务:** `lib/ai/zhipu.ts`

#### 阶段 2: 图片生成
```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 分镜描述  │────▶│ 火山引擎 │────▶│ 下载图片 │────▶│ 上传存储  │
│ + 风格   │     │ Seedream │     │          │     │          │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
```

**API:** `POST /api/generate/image/:sceneId`
**AI 服务:** `lib/ai/volc-image.ts`

#### 阶段 3: 视频生成
```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 图片URL  │────▶│ 火山引擎 │────▶│ 轮询状态 │────▶│ 下载视频  │
│ + 描述   │     │ Seedance │     │          │     │          │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
```

**API:** `POST /api/generate/video/:sceneId`
**AI 服务:** `lib/ai/volc-video.ts`

---

### 4. 确认机制

每个阶段都有确认机制：

```
┌─────────────────────────────────────────────────────────────┐
│                      确认流程                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────┐      ┌─────────┐      ┌─────────┐           │
│   │ 生成完成 │─────▶│ 用户预览 │─────▶│ 确认/重做│           │
│   └─────────┘      └─────────┘      └─────────┘           │
│                          │               │                 │
│                          │               │                 │
│                    ┌─────┴─────┐    ┌────┴────┐           │
│                    ▼           ▼    ▼         ▼           │
│              ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌────────┐│
│              │ 确认单个 │ │ 确认全部 │ │ 重做单个 │ │重做全部││
│              └─────────┘ └─────────┘ └─────────┘ └────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**确认 API:**
- 单个确认: `POST /api/scenes/:id/confirm-description`
- 批量确认: `POST /api/scenes/confirm-all-descriptions`

---

## 数据流向

```
用户输入
    │
    ▼
┌─────────┐     ┌─────────┐     ┌─────────┐
│  页面   │────▶│  API    │────▶│ 服务层  │
│ (React) │     │(Route)  │     │ (lib/)  │
└─────────┘     └─────────┘     └─────────┘
                      │              │
                      │              ▼
                      │        ┌───────────┐
                      │        │ 数据访问层 │
                      │        │  (db/)    │
                      │        └───────────┘
                      │              │
                      │              ▼
                      │        ┌───────────┐
                      └───────▶│ Supabase  │
                               │ (Database)│
                               └───────────┘
```
